# 日志系统设计规范

## 日志等级

日志等级：
- FATAL（致命）：用来输出非常严重或预期中不会发生的错误，遇到此种错误应当立即报警并人工介入处理；
- ERROR （错误）：非预期中的错误，此种错误可能导致部分系统异常但不会影响核心业务和系统正常运行；
- WARN（警告）：潜在的危险或值得关注的信息（比较核心的路径）；
- INFO（信息）：应用执行过程中的详细信息，一般通过该信息可以看到每个请求的主要执行过程；
- DEBUG（调试）：用于线下调试的日志信息，用于分析应用执行逻辑，线上应用切勿开启；
- TRACE（跟踪）：输出最细致的运行轨迹，可能包含涉及的数据内容。

## 日志内容规范

### 日志字段

日志中通常必备的字段有：Time、Level、Location。对于特定模块/流程/业务，还需要有一些 Common 的字段，例如：

如果使用 Trace 系统，可以把 TraceID 附加到日志中；
固定的流程需要附加对应的字段，例如订单的生命周期中，一定要有订单号、用户 ID 等信息，这些信息可以通过 Context 附加到对应流程的日志实例上；
HTTP 请求需要记录：URL、Method、Status、Latency、Inflow、OutFlow、ClientIP、UserAgent 等，详情可以参考 Nginx日志格式；
如果多个模块的日志都打印到同一个流/文件中，必须有字段标识模块名。

例如：
```
[2019-12-30 21:45:30.611992]    [WARNING]       [958] [block_writer.cpp:671]  path:pangu://localcluster/index/3/prom/7/1577711464522767696_0_1577711517     min_time:1577712000000000       max_time:1577715600000000       normal_count:27595      config:prom     start_line:57315569     end_line:57343195       latency(ms):42  type:AddBlock
```

日志信息可以采用**KeyValue形式**和**JSON形式**。


## 日志输出量规范

- 尽量不要一条日志输出成多行;
- 服务入口的请求和响应日志没有特殊原因都要输出并采集，采集的字段可以根据需求调整；
- 错误日志一般都要打印，如果太多，可以使用采样方式打印；
- 减少无效日志输出，尤其是循环中打印日志的情况需尽量减少；
- 请求型的日志（比如 Ingress、Nginx 访问日志）一般不超过 5MB/s（500 字节每条，不超过 1W/s），应用程序日志不超过 200KB/s（2KB 每条，不超过 100 条/s）。

**一般地，日志的性能消耗不超过整体业务系统 CPU 消耗占用的 5%**

## 日志输出目标规范

- 访问日志单独放到一个文件，如果域名不多，可以按照一个域名一个文件的形式；
- 错误类的日志单独放一个文件，单独配置监控告警；
- 调用外部系统的日志单独放一个文件，便于后续对账、审计；
